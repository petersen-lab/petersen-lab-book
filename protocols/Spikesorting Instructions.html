

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Spikesorting Instructions &#8212; Petersen Lab Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=12da95d707ffb74b382d" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=12da95d707ffb74b382d" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css-rules.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'protocols/Spikesorting Instructions';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Future Tutorial" href="../tutorials/Future%20Tutorial.html" />
    <link rel="prev" title="Setup Spikesorting Environment" href="../documentation/Spikesorting%20Environment%20Setup.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Welcome to Petersen Lab Book
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../documentation/How%20to%20Edit%20This%20Lab%20Book.html">How to Edit This Lab Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../documentation/Spikesorting%20Environment%20Setup.html">Setup Spikesorting Environment</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Protocols</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Spikesorting Instructions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../tutorials/Future%20Tutorial.html">Future Tutorial</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../resources/Spikesorting.html">Spikesorting</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/dervinism/petersen-lab-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/dervinism/petersen-lab-book/issues/new?title=Issue%20on%20page%20%2Fprotocols/Spikesorting Instructions.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/protocols/Spikesorting Instructions.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Spikesorting Instructions</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#important-cosiderations-before-doing-any-spikesorting">Important cosiderations before doing any spikesorting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-kilosort">Run Kilosort</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#launch-phy">Launch Phy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#major-manual-spikesorting-steps-using-phy">Major Manual Spikesorting Steps Using Phy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-phy-display">Configure Phy Display</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-noise-clusters">Mark Noise Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-clusters">Merge Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-clusters">Split Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-units">Mark Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-multiunit-activity">Mark Multiunit Activity</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="spikesorting-instructions">
<span id="protocols-spikesorting"></span><h1>Spikesorting Instructions<a class="headerlink" href="#spikesorting-instructions" title="Permalink to this heading">#</a></h1>
<section id="important-cosiderations-before-doing-any-spikesorting">
<h2>Important cosiderations before doing any spikesorting<a class="headerlink" href="#important-cosiderations-before-doing-any-spikesorting" title="Permalink to this heading">#</a></h2>
<p>Spikesorting involves two steps. During the first step you do the automatic spikesorting using Kilosort. During the second step you inspect the Kilosort output using Phy and make further adjustments to it. The latter part is refered to as the manual curation. Each of these steps transform the original data in many ways, often distorting it. You have to take precaution to inspect your data and seek to ensure that your data is minimally distorted/degraded by the spikesorting process.</p>
<p>In our experience, Kilosort1 works well with multi-channel high density recording probes like Neuronexus and Neuropixels. We have also used later versions of Kilosort with good results. However, there is one critical caveat to take into account when using later versions of Kilosort. Later Kilosort versions appear to reduce the overall waveform amplitude of spike clusters and reduce the number of recording channels that cluster waveforms are visible on. This might be due to any/multiple data transformations applied by Kilosort during its data preprocessing stage, like common average referencing, filtering, channel whitening, and drift correction. Whatever the cause of this issue, the way to sidestep this problem is to extract cluster waveforms directly from the raw recording traces manually for your subsequent data analyses.</p>
<p>We recommend using the latest Kilosort version (which is 3 at the time of writing this documentation) with drift correction enabled. You can use the default settings set by the KilosortWrapper. If you do not like the Kilosort output that you are getting, you can try various Kilosort set-ups and then inspecting the output yourself in Phy by comparing the output produced using different set-ups.</p>
<p>Reading these instructions is only an important first step. After reading, you should observe an experienced extracellular electrophysiologist performing the real spikesorting, explaining you every step they take. Then attempt doing it yourself and show your work to a senior lab member. Do not expect to get it right straight away, but with practice and experience you will master the skill.</p>
</section>
<section id="run-kilosort">
<span id="protocols-spikesorting-run-kilosort"></span><h2>Run Kilosort<a class="headerlink" href="#run-kilosort" title="Permalink to this heading">#</a></h2>
<p>Before you can do any manual spikesorting, you need to complete the automatic spikesorting part using Kilosort. Open Matlab and navigate to the folder containing raw extracellular electrophysiology data recorded using Neuropixels or any other probe. Run <code class="docutils literal notranslate"><span class="pre">KilosortWrapper</span></code> from that folder. You can, for example, use a similar script to the one shown below:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">algorithm</span><span class="p">=</span><span class="s">&#39;ks3&#39;</span><span class="p">;</span>
<span class="n">driftCorrection</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="n">basepath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cd</span><span class="p">;</span>
<span class="p">[</span><span class="o">~</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fileparts</span><span class="p">(</span><span class="n">basepath</span><span class="p">);</span>
<span class="n">GPU_id</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="n">procPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="n">createSubdirectory</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="n">performAutoCluster</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="n">config</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&#39;</span><span class="p">;</span>
<span class="n">phyPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;C:\Users\Martynas\Python_environments\phy&#39;</span><span class="p">;</span>
<span class="n">acqBoard</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;OpenEphys&#39;</span><span class="p">;</span>
<span class="n">probe</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Neuropixels1_checkerboard&#39;</span><span class="p">;</span>
<span class="nb">savepath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">KiloSortWrapper</span><span class="p">(</span><span class="n">basepath</span><span class="p">=</span><span class="n">basepath</span><span class="p">,</span><span class="w"> </span><span class="n">basename</span><span class="p">=</span><span class="n">basename</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">  </span><span class="n">GPU_id</span><span class="p">=</span><span class="n">GPU_id</span><span class="p">,</span><span class="w"> </span><span class="n">procPath</span><span class="p">=</span><span class="n">procPath</span><span class="p">,</span><span class="w"> </span><span class="n">createSubdirectory</span><span class="p">=</span><span class="n">createSubdirectory</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">  </span><span class="n">performAutoCluster</span><span class="p">=</span><span class="n">performAutoCluster</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">=</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">phyPath</span><span class="p">=</span><span class="n">phyPath</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">  </span><span class="n">acqBoard</span><span class="p">=</span><span class="n">acqBoard</span><span class="p">,</span><span class="w"> </span><span class="n">probe</span><span class="p">=</span><span class="n">probe</span><span class="p">);</span>
</pre></div>
</div>
<p>For more details on how to run <code class="docutils literal notranslate"><span class="pre">KilosortWrapper</span></code> type in Matlab console one of the following:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">help</span><span class="w"> </span><span class="n">KilosortWrapper</span>
<span class="nb">doc</span><span class="w"> </span><span class="n">KilosortWrapper</span>
</pre></div>
</div>
<p>If you set <code class="docutils literal notranslate"><span class="pre">createSubdirectory</span> <span class="pre">=</span> <span class="pre">true;</span></code>, Kilosort should produce a separate output folder inside the raw data folder. This is where you need to navigate using your terminal before launching Phy, as explained in the next subsection.</p>
<p>If you want to adjust Kilosort parameters, you can edit <code class="docutils literal notranslate"><span class="pre">KilosortConfiguration.m</span></code> file. You can also create a copy of this file, edit it, and move it to <code class="docutils literal notranslate"><span class="pre">./ConfigurationFiles</span></code> folder. In this case you would need to provide the path to the file using <code class="docutils literal notranslate"><span class="pre">config</span></code> parameter, for example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;&lt;KilosrtWrapper-path&gt;/ConfigurationFiles/&lt;config-file-name&gt;.m&#39;</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="launch-phy">
<span id="protocols-spikesorting-launch-phy"></span><h2>Launch Phy<a class="headerlink" href="#launch-phy" title="Permalink to this heading">#</a></h2>
<p>Open Power Shell and type in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">&lt;</span><span class="n">kilosort</span><span class="o">-</span><span class="n">output</span><span class="o">-</span><span class="n">folder</span><span class="o">&gt;</span>
<span class="o">.&lt;</span><span class="n">path</span><span class="o">-</span><span class="n">where</span><span class="o">-</span><span class="n">you</span><span class="o">-</span><span class="n">installed</span><span class="o">-</span><span class="n">phy</span><span class="o">-</span><span class="n">environment</span><span class="o">&gt;</span>\<span class="n">phy</span>\<span class="n">Scripts</span>\<span class="n">activate</span><span class="o">.</span><span class="n">ps1</span>
<span class="n">phy</span> <span class="n">template</span><span class="o">-</span><span class="n">gui</span> <span class="n">params</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>A successful launch of Phy GUI indicates that your spikesorting environment is set up and ready for manual curation of the Kilosort output.</p>
</section>
<section id="major-manual-spikesorting-steps-using-phy">
<span id="protocols-spikesorting-steps-phy"></span><h2>Major Manual Spikesorting Steps Using Phy<a class="headerlink" href="#major-manual-spikesorting-steps-using-phy" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Step 1: <a class="reference internal" href="#protocols-spikesorting-phy-displays"><span class="std std-ref">Configure Phy displays</span></a></p></li>
<li><p>Step 2:</p>
<ul>
<li><p><a class="reference internal" href="#protocols-spikesorting-noise"><span class="std std-ref">Mark noise clusters</span></a></p></li>
<li><p><a class="reference internal" href="#protocols-spikesorting-merge"><span class="std std-ref">Merge clusters</span></a></p></li>
<li><p><a class="reference internal" href="#protocols-spikesorting-split"><span class="std std-ref">Split clusters</span></a></p></li>
<li><p><a class="reference internal" href="#protocols-spikesorting-units"><span class="std std-ref">Mark ‘good’ clusters or units</span></a></p></li>
</ul>
</li>
<li><p>Step 3: <a class="reference internal" href="#protocols-spikesorting-muas"><span class="std std-ref">Mark multiunit activity (MUAs)</span></a></p></li>
</ul>
<p>Once you set up your Phy interface and are ready to start spikesorting, you would typically go through the spikesorting data twice in two major phases. During the first phase you would mark noise clusters, attempt to merge and/or split clusters, and mark so-called ‘good’ clusters or units. In the second sift though the data you would mark the remaining unclassified clusters as MUAs.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Do not lose your work!
Save your spikesorting progress periodically often. Phy may crash unexpectedly and all unsaved work would be lost. There is no autosave functionality in Phy. The shortcut for saving is <code class="docutils literal notranslate"><span class="pre">Ctrl+s</span></code>.</p>
</div>
<section id="configure-phy-display">
<span id="protocols-spikesorting-phy-displays"></span><h3>Configure Phy Display<a class="headerlink" href="#configure-phy-display" title="Permalink to this heading">#</a></h3>
<p>Configure your Phy display to include the below windows:</p>
<ul class="simple">
<li><p>ClusterView: Sort clusters based on their peak recording channel in increasing order.</p></li>
<li><p>SimilarityView</p></li>
<li><p>AmplitudeView</p></li>
<li><p>CorrelogramView: Adjust window size to be 500 ms (250 ms when doing cluster comparisons). Set bin size to 0.5 milliseconds.</p></li>
<li><p>WaveformView: Make sure that at least 32 recording channels are displayed. Single waveform duration on a single channel is 83 data points or approximately 2.77 ms.</p></li>
<li><p>FeatureView</p></li>
</ul>
<p>One way you could organise them is shown in the figure below.</p>
<a class="reference internal image-reference" href="../_images/full-phy-display.png" id="fig-protocols-spikesorting-phy-display"><img alt="../_images/full-phy-display.png" class="align-center" id="fig-protocols-spikesorting-phy-display" src="../_images/full-phy-display.png" style="width: 690px;" /></a>
<p>       <strong>Figure 1. Recommended Phy Display Arrangement</strong></p>
<p>This is just an example. The size of individual displays may be adjusted according to your preference or the your spikesorting stage.</p>
</section>
<section id="mark-noise-clusters">
<span id="protocols-spikesorting-noise"></span><h3>Mark Noise Clusters<a class="headerlink" href="#mark-noise-clusters" title="Permalink to this heading">#</a></h3>
<p>There are only three categories of clusters: ‘good’ (unit), multiunit activity (MUA), and noise. Initially, Kilosort classifies all data into units and MUA’s. This classification should be largely ignored. You should reclassify clusters and should also mark noise clusters as such (Kilosort does not mark noise). You mark a cluster as noise by selecting it in the ClusterView and pressing <code class="docutils literal notranslate"><span class="pre">Alt+n</span></code> keyboard shortcut.</p>
<p>Here are a few criteria for recognising putative noise clusers:</p>
<ul class="simple">
<li><p>Cluster autocorrelogram has a triangular shape and waveforms appear uniform across recording channels as in the example below.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example1.png" id="fig-protocols-spikesorting-noise-example1"><img alt="../_images/noise-example1.png" class="align-center" id="fig-protocols-spikesorting-noise-example1" src="../_images/noise-example1.png" style="width: 690px;" /></a>
<p>       <strong>Figure 2. Noise Cluster Example #1</strong></p>
<ul class="simple">
<li><p>Waveforms appear on all recording channels.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example2.png" id="fig-protocols-spikesorting-noise-example2"><img alt="../_images/noise-example2.png" class="align-center" id="fig-protocols-spikesorting-noise-example2" src="../_images/noise-example2.png" style="width: 690px;" /></a>
<p>       <strong>Figure 3. Noise Cluster Example #2</strong></p>
<ul class="simple">
<li><p>Waveform appearing on a single recording channel only.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example3.png" id="fig-protocols-spikesorting-noise-example3"><img alt="../_images/noise-example3.png" class="align-center" id="fig-protocols-spikesorting-noise-example3" src="../_images/noise-example3.png" style="width: 690px;" /></a>
<p>       <strong>Figure 4. Noise Cluster Example #3</strong></p>
<ul class="simple">
<li><p>Waveform appearing on a single recording channel only and having a distinctly unusual non-spike-like shape.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example4.png" id="fig-protocols-spikesorting-noise-example4"><img alt="../_images/noise-example4.png" class="align-center" id="fig-protocols-spikesorting-noise-example4" src="../_images/noise-example4.png" style="width: 690px;" /></a>
<p>       <strong>Figure 5. Noise Cluster Example #4</strong></p>
<ul class="simple">
<li><p>Unit spiking on channel 64 mixed with noise appearing on multiple channels. Splitting is not possible. Therefore, this cluster should be marked as noise.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example5.png" id="fig-protocols-spikesorting-noise-example5"><img alt="../_images/noise-example5.png" class="align-center" id="fig-protocols-spikesorting-noise-example5" src="../_images/noise-example5.png" style="width: 690px;" /></a>
<p>       <strong>Figure 6. Noise Cluster Example #5</strong></p>
<ul class="simple">
<li><p>Activity apearing on all recording channels albeit with varying amplitude. Autocorrelogram shows strong periodicity.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example6.png" id="fig-protocols-spikesorting-noise-example6"><img alt="../_images/noise-example6.png" class="align-center" id="fig-protocols-spikesorting-noise-example6" src="../_images/noise-example6.png" style="width: 690px;" /></a>
<p>       <strong>Figure 7. Noise Cluster Example #6</strong></p>
<ul class="simple">
<li><p>Activity waveform does not resemble a typical spike waveform.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/noise-example7.png" id="fig-protocols-spikesorting-noise-example7"><img alt="../_images/noise-example7.png" class="align-center" id="fig-protocols-spikesorting-noise-example7" src="../_images/noise-example7.png" style="width: 690px;" /></a>
<p>       <strong>Figure 8. Noise Cluster Example #7</strong></p>
<p>These are not exhaustive examples. You will come across many more. With practice you will learn to distinguish between biologically plausible waveforms and noise events and will learn to spot telltale signs of noise.</p>
</section>
<section id="merge-clusters">
<span id="protocols-spikesorting-merge"></span><h3>Merge Clusters<a class="headerlink" href="#merge-clusters" title="Permalink to this heading">#</a></h3>
<p>You should ideally be merging clusters as part of the spikesorting Step 2. When you go through clusters one by one, if you think that a particular cluster could be a so-called ‘good’ cluster (unit), you should check wheter the cluster can be merged with any other cluster prior to classifying the cluster. Press <code class="docutils literal notranslate"><span class="pre">spacebar</span></code> to select the next most similar cluster in the <code class="docutils literal notranslate"><span class="pre">SimilarityView</span></code>. Only ‘good’ (clusters appearing in green colour) or ‘unsorted’ (clusters appearing in white) clusters can be selected automatically. MUAs (clusters in light grey) and noise (clusters in dark grey) are ignored by default and can only be selected manually. This is the reason why you should not mark clusters as MUAs until the very end of the spikesorting process.</p>
<p>Below are the criteria to consider when merging clusters:</p>
<ul class="simple">
<li><p>The spike waveforms of the clusters being compared should be very similar and appear on the same recording channels. An exception is the apearance of spikes or noise on additional recording channels. This happens when a cluster is split into subclusters because some spikes coincide with appearance of neighbouring cluster spikes or periods of noise. Moreover, some leeway should be given to account for the electrode drift: Some cluster waveforms may differ in amplitude and their channel span somewhat due to anatomical drift over time and, hence, should really be merged.</p></li>
<li><p>The cross-correlograms should have clean refractory periods. However, if the spike waveforms are identical but the cross-correlogram refractory periods are still contaminated these clusters might be merged. Then they should be attempted to be split based on the criteria outlined in <a class="reference internal" href="#protocols-spikesorting-split"><span class="std std-ref">Split Clusters</span></a> subsection or should be kept merged and the resultant cluster re-classified as ‘unsorted’.</p></li>
<li><p>The two clusters should overlap or appear adjacent to each other in the principal component space of the FeatureView window. The merged cluster should then form a single cloud cluster in the principal component space.</p></li>
<li><p>Amplitudes of the two clusters should overlap or form continuous grouping over time in the AmplitudeView window. This is not a strict requirement as amplitudes of the two clusters may differ due to a drift or burst firing.</p></li>
</ul>
<p>You merge clusters by pressing <code class="docutils literal notranslate"><span class="pre">g</span></code>. You do this repeatedly until the cluster of interest can no longer be merged. The meged cluster should also be considered for splitting.</p>
</section>
<section id="split-clusters">
<span id="protocols-spikesorting-split"></span><h3>Split Clusters<a class="headerlink" href="#split-clusters" title="Permalink to this heading">#</a></h3>
<p>You should ideally be splitting clusters as part of the spikesorting Step 2. Splitting does not necessarily always have to be preceded by merging, as well as merging does not always have to be followed by splitting. Splitting should be attempted in certain circumstances when you think that a cluster can potentially be cleaned up (improved upon). These cases would typically involve ‘good’ units with slightly contaminated refractory periods or MUAs that have a visible dip coinciding with the refractory period. You may attempt to clean up the refractory periods of these ‘dirty’ units and MUAs.</p>
<p>These are the splitting steps you should attempt on these clusters:</p>
<ul class="simple">
<li><p>Visualise spikes in the refractory period: go to <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">&gt;&gt;</span> <span class="pre">VisualizeShortISI</span></code> in the Phy menu (or <code class="docutils literal notranslate"><span class="pre">Alt+i</span></code> keyboard shortcut). This action will split spikes with the short inter-spike interval (ISI) from the rest of the cluster. If the short ISI spikes contain only noise, they should be discarded as noise. If they contain units, they cannot be split apart and should be re-merged with the rest of the cluster they came from. On criteria for deciding when clusters should be merged or kept seprate, see the <a class="reference internal" href="#protocols-spikesorting-merge"><span class="std std-ref">Merge Clusters</span></a> subsection.</p></li>
<li><p>Inspect the FeatureView window. If you see that the cluster does not have a spherical cloud shape, this may indicate that multiple clusters were merged together. Try to separate such a cluster by drawing lines around part of the cluster (<code class="docutils literal notranslate"><span class="pre">Ctrl+left-click</span></code>) and pressing <code class="docutils literal notranslate"><span class="pre">k</span></code> to split. If you think that the two resultant clusters do not belong together, keep them separated. Otherwise, re-merge them.</p></li>
<li><p>Inspect the AmplitudeView window for unusual groupings of spikes. Try to split those apart by drawing lines around these groupings (<code class="docutils literal notranslate"><span class="pre">Ctrl+left-click</span></code>) and pressing <code class="docutils literal notranslate"><span class="pre">k</span></code> to split. These clusters may contain noise or other clusters of spikes that should be kept separate. If the resultant clusters are similar, they should be re-merged back.</p></li>
<li><p>Try splitting off outlying large amplitude spikes clearly deviating away from the median amplitude in the AmplitudeView window. These large amplitude events may be noise. However, merge them back, if they are too similar to the main cluster spikes.</p></li>
<li><p>You can draw a close line around the cloud cluster in the FeatureView window and split away any outliers. These outliers may be noise or spikes from other clusters that were merged by mistake. Discard them as noise or multiunit activity accordingly. However, you must re-merge them if these split-off spikes are similar to the spikes in the main cluster.</p></li>
<li><p>Finally, you can recluster a particular cluster of interest using <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">&gt;&gt;</span> <span class="pre">Recluster</span> <span class="pre">PCAs</span></code> action (<code class="docutils literal notranslate"><span class="pre">Alt+K</span></code>). The resulting new clusters may be significantly different from each other warranting being split into seprarate clusters. They may be different units or one of the culsters may contain noise. If the new clusers do not look significantly different, merge them back together.</p></li>
</ul>
</section>
<section id="mark-units">
<span id="protocols-spikesorting-units"></span><h3>Mark Units<a class="headerlink" href="#mark-units" title="Permalink to this heading">#</a></h3>
<p>When deciding between single unit (‘good’ unit; <code class="docutils literal notranslate"><span class="pre">Alt+g</span></code>) and multiunit activity (<code class="docutils literal notranslate"><span class="pre">Alt+m</span></code>), look for a few features:</p>
<ul class="simple">
<li><p>The refractory period in the autocorrelogram should not be contaminated with spikes. This is the most important criterion. It is reasonable to expect some minor contamination, but the refractory period should be reasonably clean (no higher than 20% level of the autocorrelogram ‘shoulders’). It may be possible to clean up the refractory period by splitting the cluster and, thus, splitting should always be considered. If the cluster cannot be cleaned up, it should be marked as unsorted (<code class="docutils literal notranslate"><span class="pre">Alt+u</span></code>).</p></li>
<li><p>The spike waveform should have a distinct shape characteristic of action potentials. It should be clean, meaning that local field potential deflections should be aligned and clearly visible on the peak channel, multiple nearby waveforms should not be present on the peak channel, and waveforms should not be contaminated by noise. This is the second key criterion.</p></li>
<li><p>‘Good’ units should have a relatively high firing rate. There is no strict threshold; however the firing rate criterion is important. If a unit has a low firing rate, its autocorrelogram is often meaningless. If you have an empty autocorrelogram, you cannot say anything about the activity during the refractory period: There are simply not enough spikes to even assess for it. However, you should always consider such clusters for merger. If they cannot be merged, they should be discarded (marked as unsorted).</p></li>
<li><p>Unit activity should appear clusterred in an eliptical manner in the principal component space shown in the FeatureView window. Violations of this requirement may indicate the presence of merged subclusters that should be split, if possible.</p></li>
<li><p>Unit amplitudes should ideally remain stable throughout the recording session. This is not a strict requirement as bursting units are likely to have multiple amplitudes. Amplitude may also change over the period of the recording due to the probe drift. However, periods where amplitude strongly deviates from the median value should be inspected for noise.</p></li>
</ul>
</section>
<section id="mark-multiunit-activity">
<span id="protocols-spikesorting-muas"></span><h3>Mark Multiunit Activity<a class="headerlink" href="#mark-multiunit-activity" title="Permalink to this heading">#</a></h3>
<p>You should do this step at the very end once you went though your data twice (Step 3). Essentially, everything that is not noise or a ‘good’ unit is a multiunit activity. This would include:</p>
<ul class="simple">
<li><p>Clusters with contaminated or no refractory periods in the autocorrelograms. If you failed to clean up a ‘dirty’ unit, it should belong here.</p></li>
<li><p>Clusters with waveforms that have multiple spikes in them.</p></li>
<li><p>Units with low firing rates.</p></li>
<li><p>If you have a hard time making a decision about a particular cluster, it most likely belongs here too.</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./protocols"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../documentation/Spikesorting%20Environment%20Setup.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Setup Spikesorting Environment</p>
      </div>
    </a>
    <a class="right-next"
       href="../tutorials/Future%20Tutorial.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Future Tutorial</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#important-cosiderations-before-doing-any-spikesorting">Important cosiderations before doing any spikesorting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-kilosort">Run Kilosort</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#launch-phy">Launch Phy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#major-manual-spikesorting-steps-using-phy">Major Manual Spikesorting Steps Using Phy</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure-phy-display">Configure Phy Display</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-noise-clusters">Mark Noise Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#merge-clusters">Merge Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#split-clusters">Split Clusters</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-units">Mark Units</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mark-multiunit-activity">Mark Multiunit Activity</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner">
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Martynas Dervinis
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div></div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=12da95d707ffb74b382d"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=12da95d707ffb74b382d"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>